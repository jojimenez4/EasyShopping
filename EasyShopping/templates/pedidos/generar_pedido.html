{% extends "../base.html" %}

{% block content %}

<div class="content-section">
    {% if messages %}
    <div class="alert alert-info">
        {% for message in messages %}
            <p>{{ message }}</p>
        {% endfor %}
    </div>
    {% endif %}

    <h1 class="mb-4">Generar Pedido</h1>

    <form method="POST">
        {% csrf_token %}

        <div class="mb-4">
            <h3>Información del Pedido</h3>
            {{ sale_form.as_p }}
        </div>

        <div class="mb-4">
            <h3>Productos</h3>
            <table class="table table-bordered" id="productos-table">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Subtotal</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="product-row">
                        <td>
                            <select class="form-control product-select" name="products[]">
                                <option value="" data-price="0" data-stock="0">Seleccione un producto</option>
                                {% for product in productos %}
                                    <option value="{{ product.id }}" data-price="{{ product.price }}" data-stock="{{ product.stock }}">
                                        {{ product.name }} (Stock: {{ product.stock }})
                                    </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <input type="number" class="form-control cantidad-input" name="cantidades[]" min="1" value="1">
                        </td>
                        <td>
                            <span class="subtotal">0.00</span>
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger remove-row">Eliminar</button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="btn btn-outline-primary" id="add-row">Agregar Producto</button>
        </div>

        <div class="d-flex justify-content-between align-items-center">
            <h4>Total: $<span id="total">0.00</span></h4>
            <button type="submit" class="btn btn-success">Finalizar Pedido</button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const table = document.querySelector('#productos-table tbody');
        const totalElement = document.querySelector('#total');

        // Actualiza el total del pedido y los subtotales de cada fila
        const updateTotals = () => {
            let total = 0;
            table.querySelectorAll('.product-row').forEach(row => {
                const price = parseFloat(row.querySelector('.product-select option:checked').dataset.price || 0);
                const cantidad = parseInt(row.querySelector('.cantidad-input').value || 0);
                const subtotal = price * cantidad;
                row.querySelector('.subtotal').textContent = subtotal.toFixed(2);
                total += subtotal;
            });
            totalElement.textContent = total.toFixed(2);
        };

        // Añadir nueva fila de producto
        document.querySelector('#add-row').addEventListener('click', () => {
            const newRow = table.querySelector('.product-row').cloneNode(true);
            newRow.querySelector('.cantidad-input').value = 1;
            newRow.querySelector('.subtotal').textContent = '0.00';
            table.appendChild(newRow);
        });

        // Actualizar el total cuando cambien las opciones del producto o la cantidad
        table.addEventListener('change', updateTotals);
        table.addEventListener('input', updateTotals);

        // Eliminar una fila de producto
        table.addEventListener('click', (event) => {
            if (event.target.classList.contains('remove-row')) {
                const row = event.target.closest('.product-row');
                if (table.rows.length > 1) {
                    row.remove();
                    updateTotals();
                }
            }
        });

        // Validar el stock antes de enviar el formulario
        document.querySelector('form').addEventListener('submit', (event) => {
            let valid = true;
            table.querySelectorAll('.product-row').forEach(row => {
                const productSelect = row.querySelector('.product-select');
                const cantidad = parseInt(row.querySelector('.cantidad-input').value);
                const stock = parseInt(productSelect.options[productSelect.selectedIndex].dataset.stock);

                if (cantidad > stock) {
                    alert(`No hay suficiente stock para el producto ${productSelect.options[productSelect.selectedIndex].text}`);
                    valid = false;
                }
            });

            if (!valid) {
                event.preventDefault();  // Evitar el envío del formulario
            }
        });
    });
</script>

{% endblock %}
