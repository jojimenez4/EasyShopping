{% extends "../base.html" %}

{% block content %}

<div class="content-section">
    {% if messages %}
    <div class="alert alert-info">
        {% for message in messages %}
        <p>{{ message }}</p>
        {% endfor %}
    </div>
    {% endif %}

    <h1 class="mb-4">Generar Pedido</h1>

    <form method="POST">
        {% csrf_token %}

        <div class="mb-4">
            <h3>Información del Pedido</h3>
            {{ sale_form.as_p }}
        </div>

        <div class="mb-4">
            <h3>Productos</h3>
            <table class="table table-bordered" id="productos-table">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Subtotal</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="product-row">
                        <td>
                            <select class="form-control product-select" name="products[]">
                                <option value="" data-precio="0" data-stock="0">Seleccione un producto</option>
                                {% for product in productos %}
                                <option value="{{ product.id }}" data-precio="{{ product.price }}"
                                    data-stock="{{ product.stock }}">
                                    {{ product.name }} (Stock: {{ product.stock }})
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <input type="number" class="form-control cantidad-input" name="cantidades[]" min="1"
                                value="1">
                        </td>
                        <td>
                            <span class="subtotal">0.00</span>
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger remove-row">Eliminar</button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="btn btn-outline-primary" id="add-row">Agregar Producto</button>
        </div>

        <div class="d-flex justify-content-between align-items-center">
            <h4>Total: $<span id="total">0.00</span></h4>
            <button type="submit" class="btn btn-success">Finalizar Pedido</button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const table = document.querySelector('#productos-table tbody');
        const totalElement = document.querySelector('#total');

        // Actualizar subtotal y total
        const fetchPrice = async (productId, row) => {
            try {
                const response = await fetch(`/inventario/get-price/${productId}/`);
                const data = await response.json();

                if (data.success) {
                    const price = parseFloat(data.precio);
                    row.setAttribute('data-precio', price); // Guarda el precio en un atributo
                    const cantidad = parseInt(row.querySelector('.cantidad-input').value || 0);
                    const subtotal = price * cantidad;
                    row.querySelector('.subtotal').textContent = subtotal.toFixed(2);
                    updateTotal();
                } else {
                    console.error(data.error);
                    row.querySelector('.subtotal').textContent = "Error";
                }
            } catch (error) {
                console.error('Error fetching product price:', error);
                row.querySelector('.subtotal').textContent = "Error";
            }
        };

        // Añadir event listeners a una fila
        const addEventListenersToRow = (row) => {
            // Evento para cambio en el select de producto
            row.querySelector('.product-select').addEventListener('change', (e) => {
                const productId = e.target.value;
                fetchPrice(productId, row);
            });

            // Evento para cambio en el input de cantidad
            row.querySelector('.cantidad-input').addEventListener('input', () => {
                const productId = row.querySelector('.product-select').value;
                if (productId) {
                    fetchPrice(productId, row);
                }
            });

            // Evento para eliminar la fila
            row.querySelector('.remove-row').addEventListener('click', () => {
                row.remove();
                updateTotal();
            });
        };

        // Actualizar el total general
        const updateTotal = () => {
            let total = 0;
            table.querySelectorAll('.product-row').forEach(row => {
                const subtotal = parseFloat(row.querySelector('.subtotal').textContent || 0);
                total += subtotal;
            });
            totalElement.textContent = total.toFixed(2);
        };

        // Añadir nueva fila
        document.querySelector('#add-row').addEventListener('click', () => {
            const templateRow = table.querySelector('.product-row'); // Toma una fila como plantilla
            const newRow = templateRow.cloneNode(true);

            // Reinicia los valores de la nueva fila
            newRow.querySelector('.cantidad-input').value = 1;
            newRow.querySelector('.subtotal').textContent = '0.00';
            newRow.querySelector('.product-select').value = '';
            newRow.removeAttribute('data-precio');

            // Añade eventos a la nueva fila
            addEventListenersToRow(newRow);

            // Agrega la fila a la tabla
            table.appendChild(newRow);
        });

        // Inicializa los eventos en las filas existentes
        table.querySelectorAll('.product-row').forEach(addEventListenersToRow);
    });


    // Validar el stock antes de enviar el formulario
    document.querySelector('form').addEventListener('submit', (event) => {
        let valid = true;
        table.querySelectorAll('.product-row').forEach(row => {
            const productSelect = row.querySelector('.product-select');
            const cantidad = parseInt(row.querySelector('.cantidad-input').value);
            const stock = parseInt(productSelect.options[productSelect.selectedIndex].dataset.stock);

            if (cantidad > stock) {
                alert(`No hay suficiente stock para el producto ${productSelect.options[productSelect.selectedIndex].text}`);
                valid = false;
            }
        });

        if (!valid) {
            event.preventDefault();  // Evitar el envío del formulario
        }
    });
</script>

{% endblock %}